<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refrigeration Data Collection</title>
    <style>
        /* Simple, mobileâ€‘friendly layout */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f2f2f2;
            color: #333;
        }
        header {
            background-color: #005a9c;
            color: #fff;
            padding: 1rem;
            text-align: center;
        }
        .container {
            padding: 1rem;
        }
        h2 {
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }
        .field {
            margin-bottom: 0.75rem;
        }
        .field label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: bold;
        }
        .field input, .field select, .field textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
            /* Capitalise first letter of each word */
            text-transform: capitalize;
        }
        .field textarea {
            resize: vertical;
        }
        .button {
            display: inline-block;
            padding: 0.5rem 1rem;
            margin-top: 1rem;
            background-color: #005a9c;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            text-align: center;
        }
        .button.secondary {
            background-color: #888;
        }
        /* Icon buttons for edit/delete â€“ no background or border */
        .icon-button {
            background: none;
            border: none;
            padding: 0;
            font-size: 1.2rem;
            cursor: pointer;
            line-height: 1;
        }
        .cards {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }
        .card {
            background-color: #fff;
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
            padding: 0.75rem 1rem;
            width: calc(50% - 1rem);
            position: relative;
            user-select: none;
            -webkit-user-select: none;
        }
        /* Drag handle icon for reordering cards */
        .drag-handle {
            position: absolute;
            top: 0.25rem;
            left: 0.25rem;
            cursor: grab;
            font-size: 1.2rem;
            user-select: none;
        }
        @media (max-width: 600px) {
            .card {
                width: 100%;
            }
        }
        .card-title {
            font-weight: bold;
            margin: 0;
        }
        .card-body p {
            margin: 0.25rem 0;
        }
        .card-actions {
            margin-top: 0.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        .card-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <header>
        <h1>Refrigeration Data Collection</h1>
    </header>
    <div class="container">
        <!-- Mode selection -->
        <div class="field">
            <label for="modeSelect">Collection Mode</label>
            <select id="modeSelect">
                <option value="data">Data Collection</option>
                <option value="detailed">Detailed Data Collection</option>
            </select>
        </div>

        <!-- Site section -->
        <div id="siteSection">
            <h2>Site Details</h2>
            <form id="siteForm">
                <input type="hidden" id="site-date" />
                <div class="field"><label for="site-customer">Customer</label><input type="text" id="site-customer" class="capitalize" required></div>
                <div class="field"><label for="site-street">Street Address</label><input type="text" id="site-street" class="capitalize" autocomplete="street-address"></div>
                <div class="field"><label for="site-city">City</label><input type="text" id="site-city" class="capitalize"></div>
                <div class="field"><label for="site-state">State</label>
                    <!-- Pre-populate states to avoid issues where JavaScript may not execute (e.g., in some mobile previews). -->
                    <select id="site-state">
                        <!-- Make California the default by specifying selected on CA -->
                        <option value="AL">AL</option><option value="AK">AK</option><option value="AZ">AZ</option><option value="AR">AR</option><option value="CA" selected>CA</option><option value="CO">CO</option><option value="CT">CT</option><option value="DE">DE</option><option value="FL">FL</option><option value="GA">GA</option><option value="HI">HI</option><option value="ID">ID</option><option value="IL">IL</option><option value="IN">IN</option><option value="IA">IA</option><option value="KS">KS</option><option value="KY">KY</option><option value="LA">LA</option><option value="ME">ME</option><option value="MD">MD</option><option value="MA">MA</option><option value="MI">MI</option><option value="MN">MN</option><option value="MS">MS</option><option value="MO">MO</option><option value="MT">MT</option><option value="NE">NE</option><option value="NV">NV</option><option value="NH">NH</option><option value="NJ">NJ</option><option value="NM">NM</option><option value="NY">NY</option><option value="NC">NC</option><option value="ND">ND</option><option value="OH">OH</option><option value="OK">OK</option><option value="OR">OR</option><option value="PA">PA</option><option value="RI">RI</option><option value="SC">SC</option><option value="SD">SD</option><option value="TN">TN</option><option value="TX">TX</option><option value="UT">UT</option><option value="VT">VT</option><option value="VA">VA</option><option value="WA">WA</option><option value="WV">WV</option><option value="WI">WI</option><option value="WY">WY</option>
                    </select>
                </div>
                <div class="field"><label for="site-zip">ZIP</label><input type="text" id="site-zip" maxlength="10"></div>
                <div class="field"><label for="site-contact">Contact</label><input type="text" id="site-contact" class="capitalize"></div>
                <div class="field"><label for="site-phone">Phone</label><input type="tel" id="site-phone"></div>
                <!-- No address suggestions populated; relies on browser autocomplete -->
                <button type="button" id="proceedBtn" class="button">Proceed to Data Collection</button>
            </form>
        </div>

        <!-- Data section (hidden until proceed) -->
        <div id="dataSection" class="hidden">
            <!-- Site info displayed when viewing entries -->
            <div id="siteInfo" style="text-align:center; font-weight:bold; margin: 0.5rem 0;"></div>
            <!-- Button to allow editing of site details after proceeding -->
            <div style="text-align:center; margin-bottom:0.5rem;">
                <button id="editSiteBtn" type="button" class="button secondary" style="font-size:0.8rem;">Edit Site Info</button>
            </div>
            <!-- Section entry buttons -->
            <h2>Add Units</h2>
            <div>
                <button id="add-evap" class="button">Add Evaporator</button>
                <button id="add-cond" class="button">Add Condenser</button>
            </div>

            <!-- Room/unit form (hidden until add clicked) -->
            <form id="roomForm" autocomplete="off" class="hidden">
                <h2 id="form-title"></h2>
                <div class="field"><label for="room-name">Room Name</label><input type="text" id="room-name" name="room-name" class="capitalize" required></div>
                <div class="field"><label for="room-mfg">Manufacturer</label><input type="text" id="room-mfg" name="room-mfg" class="capitalize"></div>
                <div class="field"><label for="room-count" id="count-label">Count</label><input type="number" id="room-count" name="room-count" min="0" inputmode="numeric" list="count-options"></div>
                <div class="field"><label for="room-fanMotorsPerUnit">Fan Motors Per Unit</label><input type="number" id="room-fanMotorsPerUnit" name="room-fanMotorsPerUnit" min="0" inputmode="numeric" list="count-options"></div>
                <div class="field"><label for="room-voltage">Voltage</label>
                    <select id="room-voltage" name="room-voltage">
                        <option value="">â€”</option>
                        <option value="460">460</option>
                        <option value="230">230</option>
                        <option value="115">115</option>
                    </select>
                </div>
                <div class="field"><label for="room-phase">Phase</label>
                    <select id="room-phase" name="room-phase">
                        <option value="">â€”</option>
                        <option value="3">3</option>
                        <option value="1">1</option>
                    </select>
                </div>
                <div class="field"><label for="room-amps">Amps/FLA EA</label><input type="number" id="room-amps" name="room-amps" min="0" step="0.01" inputmode="decimal"></div>
                <div class="field"><label for="room-hp">HP</label><input type="text" id="room-hp" name="room-hp"></div>
                <div class="field"><label for="room-motorMounting">Motor Mount</label>
                    <select id="room-motorMounting" name="room-motorMounting">
                        <option value="">â€”</option>
                        <option value="base">Base</option>
                        <option value="squirrel">Squirrel</option>
                        <option value="custom">Custom (specify)</option>
                    </select>
                </div>
                <div class="field hidden" id="custom-mount-field"><label for="room-motorMountingCustom">Custom Mount</label><input type="text" id="room-motorMountingCustom" name="room-motorMountingCustom"></div>
                <div class="field"><label for="room-frame">Frame</label><input type="text" id="room-frame" name="room-frame"></div>
                <div class="field"><label for="room-rpm">RPM</label><input type="number" id="room-rpm" name="room-rpm" min="0" inputmode="numeric"></div>
                <!-- Condenser specific: split condenser -->
                <div class="field hidden" id="split-field"><label for="room-split">Split Condenser?</label>
                    <select id="room-split" name="room-split">
                        <option value="No">No</option>
                        <option value="Yes">Yes</option>
                    </select>
                </div>
                <!-- Detailed fields (hidden in data mode) -->
                <div id="detailedFields" class="hidden">
                    <div class="field"><label for="room-bladeSpec">Blade Size/Pitch/Wing#</label><input type="text" id="room-bladeSpec" name="room-bladeSpec"></div>
                    <div class="field"><label for="room-shaftAdapters">Shaft Adapters?</label>
                        <select id="room-shaftAdapters" name="room-shaftAdapters">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                    <!-- Adapter type appears when shaft adapters set to Yes -->
                    <div class="field hidden" id="adapter-type-field"><label for="room-shaftAdapterType">Adapter Type</label><input type="text" id="room-shaftAdapterType" name="room-shaftAdapterType"></div>
                    <div class="field"><label for="room-bladesNeeded"># Blades Needed</label><input type="number" id="room-bladesNeeded" name="room-bladesNeeded" min="0" list="blades-options"></div>
                    <div class="field"><label for="room-runTime">Run Time</label><input type="text" id="room-runTime" name="room-runTime"></div>
                    <div class="field"><label for="room-shaftSize">Shaft Size</label><input type="text" id="room-shaftSize" name="room-shaftSize"></div>
                    <div class="field"><label for="room-rotation">Rotation (OSE)</label>
                        <select id="room-rotation" name="room-rotation">
                            <option value="">â€”</option>
                            <option value="CCW">CCW</option>
                            <option value="CW">CW</option>
                        </select>
                    </div>
                </div>
                <div class="field"><label for="room-notes">Notes</label><textarea id="room-notes" name="room-notes" rows="3"></textarea></div>
                <input type="hidden" id="room-section" />
                <input type="hidden" id="room-mode" />
                <button type="submit" class="button">Save Unit</button>
                <button type="button" id="cancelBtn" class="button secondary">Cancel</button>
            </form>

            <!-- Datalist options for counts -->
            <datalist id="count-options"></datalist>
            <!-- Datalist for blades numbers (updated dynamically) -->
            <datalist id="blades-options"></datalist>

            <!-- Cards containers for evaporators and condensers -->
            <h2>Evaporators</h2>
            <div id="cards-evap" class="cards"></div>
            <h2>Condensers</h2>
            <div id="cards-cond" class="cards"></div>
            <!-- Export/Import buttons moved below the cards -->
            <div id="exportImportSection" style="margin-top:1rem;">
                <button id="exportBtn" class="button secondary">Export CSV</button>
                <button id="importBtn" class="button secondary">Import CSV</button>
                <input type="file" id="importFile" accept=".csv" class="hidden" />
            </div>
        </div>
    </div>

    <script>
    (function() {
        const modeSelect = document.getElementById('modeSelect');
        const roomForm = document.getElementById('roomForm');
        const exportBtn = document.getElementById('exportBtn');
        const evapBtn = document.getElementById('add-evap');
        const condBtn = document.getElementById('add-cond');
        const evapCardsContainer = document.getElementById('cards-evap');
        const condCardsContainer = document.getElementById('cards-cond');
        const formTitle = document.getElementById('form-title');
        const cancelBtn = document.getElementById('cancelBtn');
        const siteSection = document.getElementById('siteSection');
        const dataSection = document.getElementById('dataSection');
        const proceedBtn = document.getElementById('proceedBtn');
        const siteForm = document.getElementById('siteForm');

        // autoâ€‘fill date field with today if not set
        (function() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const dateStr = `${yyyy}-${mm}-${dd}`;
            const dateInput = document.getElementById('site-date');
            if (dateInput && !dateInput.value) {
                dateInput.value = dateStr;
            }
        })();

        // Data in memory only; to support offline use we will also mirror to localStorage
        let siteData = {};
        let entries = [];
        let editIndex = null;

        // Save current project (siteData and entries) into localStorage so work is not lost
        function saveProject() {
            const data = { siteData, entries };
            try {
                localStorage.setItem('currentProject', JSON.stringify(data));
            } catch (e) {
                // ignore storage errors (e.g., private mode)
            }
        }

        // Load existing project from localStorage, if any.  This allows offline work to resume after a page reload.
        function loadProject() {
            const dataStr = localStorage.getItem('currentProject');
            if (!dataStr) return;
            try {
                const data = JSON.parse(dataStr);
                if (data.siteData) siteData = data.siteData;
                if (data.entries) entries = data.entries;
                // If we have site data or entries, populate the form and show the data section
                if (siteData && (siteData.customer || entries.length > 0)) {
                    // Populate site fields
                    document.getElementById('site-date').value = siteData.date || document.getElementById('site-date').value;
                    document.getElementById('site-customer').value = siteData.customer || '';
                    document.getElementById('site-street').value = siteData.street || '';
                    document.getElementById('site-city').value = siteData.city || '';
                    document.getElementById('site-state').value = siteData.state || 'CA';
                    document.getElementById('site-zip').value = siteData.zip || '';
                    document.getElementById('site-contact').value = siteData.contact || '';
                    document.getElementById('site-phone').value = siteData.phone || '';
                    // Skip site entry and show data section
                    siteSection.classList.add('hidden');
                    dataSection.classList.remove('hidden');
                    // update site info display
                    const siteInfoEl = document.getElementById('siteInfo');
                    if (siteInfoEl) {
                        const { customer, street, city, state, zip } = siteData;
                        let info = '';
                        if (customer) info += customer;
                        const addressParts = [];
                        if (street) addressParts.push(street);
                        if (city) addressParts.push(city);
                        if (state) addressParts.push(state);
                        if (zip) addressParts.push(zip);
                        if (addressParts.length > 0) info += ' â€“ ' + addressParts.join(', ');
                        siteInfoEl.textContent = info;
                    }
                    // render any existing entries
                    renderEntries();
                }
            } catch (e) {
                // invalid data, ignore
            }
        }

        // Set default state value to CA if not already selected
        const stateSelect = document.getElementById('site-state');
        if (stateSelect && !stateSelect.value) {
            stateSelect.value = 'CA';
        }

        // Format phone input as (xxx) xxx-xxxx during input
        const phoneInput = document.getElementById('site-phone');
        if (phoneInput) {
            phoneInput.addEventListener('input', (e) => {
                // Remove non-digit characters
                let digits = e.target.value.replace(/\D/g, '');
                let formatted = '';
                if (digits.length > 0) {
                    formatted += '(' + digits.substring(0, Math.min(3, digits.length));
                }
                if (digits.length >= 4) {
                    formatted += ') ' + digits.substring(3, Math.min(6, digits.length));
                }
                if (digits.length >= 7) {
                    formatted += '-' + digits.substring(6, 10);
                }
                e.target.value = formatted;
            });
        }

        // Populate count datalist (1-100)
        const countList = document.getElementById('count-options');
        for (let i = 1; i <= 100; i++) {
            const opt = document.createElement('option');
            opt.value = i;
            countList.appendChild(opt);
        }

        // Save site fields in memory only (no persistence).  Whenever a field changes we update siteData.
        siteForm.addEventListener('change', () => {
            siteData.date = document.getElementById('site-date').value;
            siteData.customer = document.getElementById('site-customer').value;
            siteData.street = document.getElementById('site-street').value;
            siteData.city = document.getElementById('site-city').value;
            siteData.state = document.getElementById('site-state').value;
            siteData.zip = document.getElementById('site-zip').value;
            siteData.contact = document.getElementById('site-contact').value;
            siteData.phone = document.getElementById('site-phone').value;

            // Persist site data changes
            saveProject();
        });

        // Address suggestions: user does not want persistence or previous entry suggestions,
        // so we do not populate the datalist. The browser's builtâ€‘in autocomplete may still assist.

        // Proceed button: hide site section and show data section
        proceedBtn.addEventListener('click', () => {
            // store site data one last time
            siteData.date = document.getElementById('site-date').value;
            siteData.customer = document.getElementById('site-customer').value;
            siteData.street = document.getElementById('site-street').value;
            siteData.city = document.getElementById('site-city').value;
            siteData.state = document.getElementById('site-state').value;
            siteData.zip = document.getElementById('site-zip').value;
            siteData.contact = document.getElementById('site-contact').value;
            siteData.phone = document.getElementById('site-phone').value;
            // hide site section and show data section
            siteSection.classList.add('hidden');
            dataSection.classList.remove('hidden');

            // update site info display
            const siteInfoEl = document.getElementById('siteInfo');
            if (siteInfoEl) {
                const { customer, street, city, state, zip } = siteData;
                let info = '';
                if (customer) info += customer;
                const addressParts = [];
                if (street) addressParts.push(street);
                if (city) addressParts.push(city);
                if (state) addressParts.push(state);
                if (zip) addressParts.push(zip);
                if (addressParts.length > 0) info += ' â€“ ' + addressParts.join(', ');
                siteInfoEl.textContent = info;
            }
        });

        // Show/hide detailed fields depending on mode (for extended features)
        function updateMode() {
            const isDetailed = modeSelect.value === 'detailed';
            const detailedFields = document.getElementById('detailedFields');
            if (isDetailed) {
                detailedFields.classList.remove('hidden');
            } else {
                detailedFields.classList.add('hidden');
            }
        }
        modeSelect.addEventListener('change', updateMode);
        updateMode();

        // When mode changes, update hidden field for form
        modeSelect.addEventListener('change', () => {
            const mode = modeSelect.value;
            const roomModeHidden = document.getElementById('room-mode');
            if (roomModeHidden) roomModeHidden.value = mode;
        });

        // Current section (evap or cond) when adding
        let currentSection = null;

        evapBtn.addEventListener('click', () => {
            currentSection = 'evap';
            openForm();
        });
        condBtn.addEventListener('click', () => {
            currentSection = 'cond';
            openForm();
        });
        // Cancel button hides the form and clears editIndex
        cancelBtn.addEventListener('click', () => {
            closeForm();
            editIndex = null;
        });

        function openForm(entry, index) {
            // set form title and labels based on section
            if (currentSection === 'evap') {
                formTitle.textContent = 'New Evaporator';
                document.getElementById('count-label').textContent = 'Evaporator Count';
                document.getElementById('split-field').classList.add('hidden');
            } else {
                formTitle.textContent = 'New Condenser';
                document.getElementById('count-label').textContent = 'Condenser Count';
                document.getElementById('split-field').classList.remove('hidden');
            }
            // update mode (show/hide detailed fields)
            updateMode();
            // show form
            roomForm.classList.remove('hidden');
            // set hidden fields
            document.getElementById('room-section').value = currentSection;
            document.getElementById('room-mode').value = modeSelect.value;
            // if index provided, we are editing existing entry
            if (typeof index === 'number') {
                editIndex = index;
            } else if (!entry) {
                editIndex = null;
                roomForm.reset();
                document.getElementById('custom-mount-field').classList.add('hidden');
            }
            if (entry) {
                // populate fields
                document.getElementById('room-name').value = entry['room-name'] || '';
                document.getElementById('room-mfg').value = entry['room-mfg'] || '';
                document.getElementById('room-count').value = entry['room-count'] || '';
                document.getElementById('room-fanMotorsPerUnit').value = entry['room-fanMotorsPerUnit'] || '';
                document.getElementById('room-voltage').value = entry['room-voltage'] || '';
                document.getElementById('room-phase').value = entry['room-phase'] || '';
                document.getElementById('room-amps').value = entry['room-amps'] || '';
                document.getElementById('room-hp').value = entry['room-hp'] || '';
                document.getElementById('room-motorMounting').value = entry['room-motorMounting'] || '';
                document.getElementById('room-frame').value = entry['room-frame'] || '';
                document.getElementById('room-rpm').value = entry['room-rpm'] || '';
                document.getElementById('room-notes').value = entry['room-notes'] || '';
                document.getElementById('room-section').value = entry.section || currentSection;
                document.getElementById('room-mode').value = entry.mode || modeSelect.value;
                // condenser specific
                if (entry.section === 'cond') {
                    document.getElementById('room-split').value = entry['room-split'] || 'No';
                }
                // detailed fields
                document.getElementById('room-bladeSpec').value = entry['room-bladeSpec'] || '';
                // set shaft adapters select and adapter type field
                const shaftSelect = document.getElementById('room-shaftAdapters');
                const adapterTypeField = document.getElementById('adapter-type-field');
                const adapterTypeInput = document.getElementById('room-shaftAdapterType');
                const shaftVal = entry['room-shaftAdapters'] || 'No';
                shaftSelect.value = shaftVal;
                if (shaftVal === 'Yes') {
                    adapterTypeField.classList.remove('hidden');
                    adapterTypeInput.value = entry['room-shaftAdapterType'] || '';
                } else {
                    adapterTypeField.classList.add('hidden');
                    adapterTypeInput.value = '';
                }
                document.getElementById('room-bladesNeeded').value = entry['room-bladesNeeded'] || '';
                document.getElementById('room-runTime').value = entry['room-runTime'] || '';
                document.getElementById('room-shaftSize').value = entry['room-shaftSize'] || '';
                document.getElementById('room-rotation').value = entry['room-rotation'] || '';
                // custom mount
                if (entry['room-motorMounting'] === 'custom' || entry['room-motorMountingCustom']) {
                    document.getElementById('room-motorMounting').value = 'custom';
                    document.getElementById('custom-mount-field').classList.remove('hidden');
                    document.getElementById('room-motorMountingCustom').value = entry['room-motorMountingCustom'] || '';
                }
            }
            // update blades options if in detailed mode
            updateBladesOptions();
            // focus
            document.getElementById('room-name').focus();
            // update Enter navigation
            setupEnterNavigation();

            // hide export/import buttons while form is open
            const exportImport = document.getElementById('exportImportSection');
            if (exportImport) exportImport.classList.add('hidden');
        }

        function closeForm() {
            roomForm.reset();
            roomForm.classList.add('hidden');
            document.getElementById('custom-mount-field').classList.add('hidden');
            // show export/import buttons again
            const exportImport = document.getElementById('exportImportSection');
            if (exportImport) exportImport.classList.remove('hidden');
        }

        // respond to motor mount selection to show custom field
        document.getElementById('room-motorMounting').addEventListener('change', (e) => {
            if (e.target.value === 'custom') {
                document.getElementById('custom-mount-field').classList.remove('hidden');
            } else {
                document.getElementById('custom-mount-field').classList.add('hidden');
                document.getElementById('room-motorMountingCustom').value = '';
            }
        });

        // show/hide adapter type field based on shaft adapters yes/no
        document.getElementById('room-shaftAdapters').addEventListener('change', (e) => {
            if (e.target.value === 'Yes') {
                document.getElementById('adapter-type-field').classList.remove('hidden');
            } else {
                document.getElementById('adapter-type-field').classList.add('hidden');
                document.getElementById('room-shaftAdapterType').value = '';
            }
        });

        // Do not reformat amps field; user may input decimals or integers directly

        // Save a new or edited unit entry
        roomForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(roomForm);
            const entry = {};
            formData.forEach((value, key) => {
                entry[key] = value.trim();
            });
            // assign section and mode from hidden inputs (fall back to current values)
            entry.section = document.getElementById('room-section').value || currentSection;
            entry.mode = document.getElementById('room-mode').value || modeSelect.value;
            // remove hidden keys from entry object
            delete entry['room-section'];
            delete entry['room-mode'];
            // if motor mounting is custom, capture custom value
            if (entry['room-motorMounting'] === 'custom') {
                entry['room-motorMountingCustom'] = formData.get('room-motorMountingCustom')?.trim() || '';
            }
            // Determine if we are editing or adding new
            if (editIndex !== null && editIndex >= 0) {
                // replace existing entry
                entries[editIndex] = entry;
                editIndex = null;
            } else {
                entries.push(entry);
            }
            renderEntries();
            closeForm();
        });

        // Render cards into separate containers
        function renderEntries() {
            evapCardsContainer.innerHTML = '';
            condCardsContainer.innerHTML = '';
            entries.forEach((entry, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                // Build header containing drag handle and title on same line
                const headerDiv = document.createElement('div');
                headerDiv.className = 'card-header';
                const handle = document.createElement('span');
                handle.className = 'drag-handle';
                handle.textContent = '\u2261'; // â‰¡
                const title = document.createElement('div');
                title.className = 'card-title';
                title.textContent = entry['room-name'] || `Unit ${index + 1}`;
                headerDiv.appendChild(handle);
                headerDiv.appendChild(title);
                card.appendChild(headerDiv);

                // Build summary using original 4 x 4 format but include total motors at end
                let summary = '';
                const countVal = entry['room-count'] || '';
                const fansVal = entry['room-fanMotorsPerUnit'] || '';
                if (countVal || fansVal) {
                    const boldCount = `<strong>${countVal}</strong>`;
                    const boldFans = `<strong>${fansVal}</strong>`;
                    summary += `<u>${boldCount} x ${boldFans}</u>`;
                }
                const specParts = [];
                if (entry['room-voltage']) {
                    specParts.push(`${entry['room-voltage']}v`);
                }
                if (entry['room-phase']) {
                    specParts.push(`${entry['room-phase']}-ph`);
                }
                if (entry['room-amps']) {
                    specParts.push(`${entry['room-amps']} amp`);
                }
                if (entry['room-hp']) {
                    specParts.push(`<strong>${entry['room-hp']}HP</strong>`);
                }
                // total fan motors
                const countInt = parseInt(entry['room-count'] || '0', 10);
                const fansInt = parseInt(entry['room-fanMotorsPerUnit'] || '0', 10);
                if (!isNaN(countInt) && !isNaN(fansInt) && countInt > 0 && fansInt > 0) {
                    const totalMotors = countInt * fansInt;
                    specParts.push(`<strong>Total Fan Motors: ${totalMotors}</strong>`);
                }
                if (summary) {
                    summary += specParts.length ? ': ' + specParts.join(', ') : '';
                } else {
                    summary = specParts.join(', ');
                }
                const body = document.createElement('div');
                body.className = 'card-body';
                body.innerHTML = `<p>${summary}</p>`;

                // Action buttons container
                const actions = document.createElement('div');
                actions.className = 'card-actions';
                // Edit button (pencil icon)
                const editBtn = document.createElement('span');
                editBtn.className = 'icon-button';
                editBtn.textContent = 'âœï¸';
                editBtn.title = 'Edit';
                editBtn.setAttribute('role','button');
                editBtn.addEventListener('click', () => {
                    currentSection = entry.section;
                    openForm(entry, index);
                });
                // Delete button (trash icon)
                const deleteBtn = document.createElement('span');
                deleteBtn.className = 'icon-button';
                deleteBtn.textContent = 'ðŸ—‘ï¸';
                deleteBtn.title = 'Delete';
                deleteBtn.setAttribute('role','button');
                deleteBtn.addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    if (confirm('Are you sure you want to delete this unit?')) {
                        entries.splice(index, 1);
                        if (editIndex !== null) {
                            if (index < editIndex) {
                                editIndex--;
                            } else if (index === editIndex) {
                                editIndex = null;
                            }
                        }
                        renderEntries();
                    }
                });
                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);

                card.appendChild(body);
                card.appendChild(actions);
                // assign attributes and append to correct container
                if (entry.section === 'evap') {
                    card.setAttribute('data-index', index);
                    card.setAttribute('draggable', 'true');
                    evapCardsContainer.appendChild(card);
                } else {
                    card.setAttribute('data-index', index);
                    card.setAttribute('draggable', 'true');
                    condCardsContainer.appendChild(card);
                }
            });
            // After rendering cards, setup drag-and-drop
            setupDragAndDrop();

            // Persist changes to localStorage
            saveProject();
        }

        // initial render
        renderEntries();

        // Export CSV
        exportBtn.addEventListener('click', () => {
            if (entries.length === 0) {
                alert('No entries to export.');
                return;
            }
            // Prepare CSV with site data header and separate entry rows
            // First rows: site keys and values
            const siteKeys = ['Customer','Street','City','State','ZIP','Contact','Phone','Date'];
            const siteVals = [];
            siteVals.push(siteData.customer || '');
            siteVals.push(siteData.street || '');
            siteVals.push(siteData.city || '');
            siteVals.push(siteData.state || '');
            siteVals.push(siteData.zip || '');
            siteVals.push(siteData.contact || '');
            siteVals.push(siteData.phone || '');
            siteVals.push(siteData.date || '');
            const csvRows = [];
            // row 1: site keys
            csvRows.push(siteKeys.map(v => '"' + v.replace(/"/g,'""') + '"').join(','));
            // row 2: site values
            csvRows.push(siteVals.map(v => '"' + String(v).replace(/"/g,'""') + '"').join(','));
            // blank row
            csvRows.push('');
            // Determine all unique entry keys
            const entryKeySet = new Set();
            entries.forEach(entry => {
                Object.keys(entry).forEach(k => entryKeySet.add(k));
            });
            const entryKeys = Array.from(entryKeySet);
            // Write header row starting with room-name first if exists
            entryKeys.sort((a,b) => {
                if (a === 'room-name') return -1;
                if (b === 'room-name') return 1;
                return a.localeCompare(b);
            });
            csvRows.push(entryKeys.map(k => '"' + k.replace(/"/g,'""') + '"').join(','));
            // Write each entry row
            entries.forEach(entry => {
                const row = entryKeys.map(k => {
                    const val = entry[k] ? entry[k].replace(/"/g,'""') : '';
                    return '"' + val + '"';
                });
                csvRows.push(row.join(','));
            });
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            // Determine filename: Data Collection - Customer Name m.d.yy
            const dateStr = siteData.date ? (function(dStr){
                const d = new Date(dStr);
                const m = d.getMonth()+1;
                const da = d.getDate();
                const y = String(d.getFullYear()).slice(-2);
                return `${m}.${da}.${y}`;
            })(siteData.date) : '';
            const namePart = siteData.customer ? siteData.customer.trim() : 'Unknown';
            const filename = `Data Collection - ${namePart} ${dateStr}.csv`;
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // After exporting, clear the saved project so it doesn't persist unnecessarily
            try {
                localStorage.removeItem('currentProject');
            } catch(e) {}
        });

        // Import CSV: load previously exported data (site data and entries)
        const importBtn = document.getElementById('importBtn');
        const importFileInput = document.getElementById('importFile');
        importBtn.addEventListener('click', () => {
            importFileInput.click();
        });
        importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                const text = ev.target.result;
                try {
                    const lines = text.trim().split(/\r?\n/);
                    if (lines.length < 2) throw new Error('No data');
                    const headers = lines[0].split(',').map(h => h.replace(/^"|"$/g, ''));
                    // Reset siteData and entries
                    siteData = {};
                    entries = [];
                    // Determine site keys (prefixed with 'site_')
                    const siteKeys = headers.filter(h => h.startsWith('site_'));
                    const entryKeys = headers.filter(h => !h.startsWith('site_'));
                    // parse each row
                    lines.slice(1).forEach(line => {
                        if (!line.trim()) return;
                        const vals = [];
                        let inside = false;
                        let current = '';
                        for (let i = 0; i < line.length; i++) {
                            const ch = line[i];
                            if (ch === '"') {
                                if (inside && line[i+1] === '"') {
                                    current += '"';
                                    i++;
                                } else {
                                    inside = !inside;
                                }
                            } else if (ch === ',' && !inside) {
                                vals.push(current);
                                current = '';
                            } else {
                                current += ch;
                            }
                        }
                        vals.push(current);
                        const rowObj = {};
                        headers.forEach((h, idx) => {
                            rowObj[h] = vals[idx] || '';
                        });
                        // populate siteData from first row only
                        siteKeys.forEach(sk => {
                            const key = sk.replace('site_', '');
                            if (!siteData[key]) siteData[key] = rowObj[sk];
                        });
                        // create entry for each row
                        const entry = {};
                        entryKeys.forEach(k => {
                            entry[k] = rowObj[k];
                        });
                        entries.push(entry);
                    });
                    // populate site form values and show data section
                    document.getElementById('site-date').value = siteData.date || '';
                    document.getElementById('site-customer').value = siteData.customer || '';
                    document.getElementById('site-street').value = siteData.street || '';
                    document.getElementById('site-city').value = siteData.city || '';
                    document.getElementById('site-state').value = siteData.state || 'CA';
                    document.getElementById('site-zip').value = siteData.zip || '';
                    document.getElementById('site-contact').value = siteData.contact || '';
                    document.getElementById('site-phone').value = siteData.phone || '';
                    // hide site section and show data section
                    siteSection.classList.add('hidden');
                    dataSection.classList.remove('hidden');
                    // update site info display after import
                    const siteInfoEl = document.getElementById('siteInfo');
                    if (siteInfoEl) {
                        const { customer, street, city, state, zip } = siteData;
                        let info = '';
                        if (customer) info += customer;
                        const addressParts = [];
                        if (street) addressParts.push(street);
                        if (city) addressParts.push(city);
                        if (state) addressParts.push(state);
                        if (zip) addressParts.push(zip);
                        if (addressParts.length > 0) info += ' â€“ ' + addressParts.join(', ');
                        siteInfoEl.textContent = info;
                    }
                    renderEntries();
                } catch(err) {
                    alert('Failed to import: ' + err.message);
                }
            };
            reader.readAsText(file);
        });

        // Edit Site Info button: show the site entry form again for editing
        const editSiteBtn = document.getElementById('editSiteBtn');
        if (editSiteBtn) {
            editSiteBtn.addEventListener('click', () => {
                // Populate the site form with current siteData values
                document.getElementById('site-date').value = siteData.date || document.getElementById('site-date').value;
                document.getElementById('site-customer').value = siteData.customer || '';
                document.getElementById('site-street').value = siteData.street || '';
                document.getElementById('site-city').value = siteData.city || '';
                document.getElementById('site-state').value = siteData.state || 'CA';
                document.getElementById('site-zip').value = siteData.zip || '';
                document.getElementById('site-contact').value = siteData.contact || '';
                document.getElementById('site-phone').value = siteData.phone || '';
                // Show site section and hide data section
                siteSection.classList.remove('hidden');
                dataSection.classList.add('hidden');
            });
        }

        // Setup Enter navigation inside the form: move to next visible field or submit
        function setupEnterNavigation() {
            const allInputs = Array.from(roomForm.querySelectorAll('input, textarea, select'));
            allInputs.forEach((input) => {
                input.removeEventListener('keydown', handleEnter);
                input.addEventListener('keydown', handleEnter);
            });
        }
        function handleEnter(e) {
            if (e.key === 'Enter') {
                // ignore select elements to prevent default submit
                if (e.target.tagName.toLowerCase() === 'select') return;
                e.preventDefault();
                const allInputs = Array.from(roomForm.querySelectorAll('input, textarea, select'));
                const visible = allInputs.filter(inp => !inp.closest('.field') || !inp.closest('.field').classList.contains('hidden'));
                const idx = visible.indexOf(e.target);
                if (idx >= 0 && idx < visible.length - 1) {
                    visible[idx + 1].focus();
                } else {
                    roomForm.requestSubmit();
                }
            }
        }

        // call setupEnterNavigation initially and whenever form is opened
        setupEnterNavigation();

        // initial render
        renderEntries();

        // Update blades options based on count and fan motors per unit
        function updateBladesOptions() {
            const bladesList = document.getElementById('blades-options');
            const count = parseInt(document.getElementById('room-count').value || '0', 10);
            const fans = parseInt(document.getElementById('room-fanMotorsPerUnit').value || '0', 10);
            const max = count * fans;
            bladesList.innerHTML = '';
            // always include 0 (none needed)
            for (let i = 0; i <= max; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                bladesList.appendChild(opt);
            }
        }

        // Whenever count or fans per unit changes, update blades options
        document.getElementById('room-count').addEventListener('input', updateBladesOptions);
        document.getElementById('room-fanMotorsPerUnit').addEventListener('input', updateBladesOptions);

        // Enable drag-and-drop sorting within each section
        function setupDragAndDrop() {
            const sections = { 'evap': evapCardsContainer, 'cond': condCardsContainer };
            Object.keys(sections).forEach(section => {
                const container = sections[section];
                container.addEventListener('dragstart', (e) => {
                    if (e.target && e.target.classList.contains('card')) {
                        e.target.classList.add('dragging');
                    }
                });
                container.addEventListener('dragend', (e) => {
                    if (e.target && e.target.classList.contains('card')) {
                        e.target.classList.remove('dragging');
                    }
                });
                container.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const dragging = container.querySelector('.dragging');
                    if (!dragging) return;
                    const afterElement = getDragAfterElement(container, e.clientY);
                    if (afterElement == null) {
                        container.appendChild(dragging);
                    } else {
                        container.insertBefore(dragging, afterElement);
                    }
                });
                container.addEventListener('drop', () => {
                    // Build new order indices for this section
                    const orderedIndices = Array.from(container.children).map(card => parseInt(card.getAttribute('data-index')));
                    // Extract current entries for section and others
                    const current = entries.filter((ent, idx) => ent.section === section);
                    const others = entries.filter((ent, idx) => ent.section !== section);
                    // Build new section entries in the order of orderedIndices
                    const newSectionEntries = orderedIndices.map(i => entries[i]).filter(ent => ent.section === section);
                    // Reconstruct entries array preserving order: for evaporators, then condensers
                    if (section === 'evap') {
                        entries = newSectionEntries.concat(others);
                    } else {
                        // cond
                        entries = others.concat(newSectionEntries);
                    }
                    renderEntries();
                });
            });
        }
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Auto-capitalize inputs with class 'capitalize' on blur so that
        // underlying values have initial caps. This does not affect numbers.
        function capitalizeWords(str) {
            return str.split(/\s+/).map(word => {
                if (!word) return '';
                // Preserve mixed-case words like "KE2" or numbers
                return word.charAt(0).toUpperCase() + word.slice(1);
            }).join(' ');
        }
        function attachCapitalization() {
            const caps = document.querySelectorAll('input.capitalize, textarea.capitalize');
            caps.forEach(el => {
                el.addEventListener('blur', () => {
                    el.value = capitalizeWords(el.value);
                });
            });
        }
        // attach once at initialization
        attachCapitalization();
        // load any saved project from localStorage so offline work resumes
        loadProject();
    })();
    </script>
</body>
</html>